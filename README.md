# Medits_ISDbayes_commercial_species
Fishing and warming reshape the central Mediterranean. Using 2000–2023 size spectra for nine species (3 fish, 3 crustaceans, 3 cephalopods), we show joint stressors shrink fish sizes and biomass, while crustaceans/cephalopods respond differently, reflecting plasticity. Management should integrate climate and fishing to sustain resilience.

# ISD Medits Tutorial — README

This repository/script reproduces a tidy workflow to:

prepare MEDITS trawl survey data, standardize counts/biomass by swept area, fit a truncated-Pareto (size-spectrum) model with a Fishing × Temperature interaction using brms + isdbayes, and visualize conditional effects and summarize the interaction (with CIs) for quick interpretation.

# Contents

script.R — the fully annotated analysis script (your main entry point).

README.md — this file.

# Optional outputs generated by the script:

A filled contour plot of the interaction surface (λ vs. fishing & temperature).

An interaction lines plot (categorical moderator) from a simple descriptive LM.

Tidy 95% CIs for the LM coefficients.

# Data Inputs

You should already have two data frames in your R session (or load them before running the script):

TA_GSA16_treated_new — haul-level/ancillary info (gear/area/effort/environment).

Medits_TC_GSA16_1994_2023 — length-class tallies per haul/species.

Required columns

TA (haul/ancillary)

WING_OPENING, DISTANCE — for swept area calculation.

HAUL_NUMBER, YEAR, AREA — used to build HAUL_ID.

Fishing — fishing effort covariate.

thetao_mean or BOTTOM_TEMPERATURE_BEGINNING — temperature covariate(s).

HAULING_DEPTH — optional depth covariate (log-transformed).

lon, lat — optional mapping checks.

TC (length classes)

HAUL_NUMBER, YEAR, AREA — to build HAUL_ID.

GENUS, SPECIES — to build Fullname (species code).

LENGTH_CLASS — length bin (mm).

NUMBER_OF_INDIVIDUALS_IN_THE_LENGTH_CLASS_AND_MATURITY_STAGE — counts.

WEIGHT_OF_THE_FRACTION, WEIGHT_OF_THE_SAMPLE_MEASURED — subsampling correction.

After joining on HAUL_ID, you may see YEAR.x (from TC) and YEAR.y (from TA).

# Software Requirements

R ≥ 4.2 and the following packages:

c(
  "dplyr","tidyr","readxl","tidyverse","ggplot2","ggthemes","scales",
  "gridExtra","automap","sf","terra","sp","raster","spdep",
  "interactions","isdbayes","brms","tidybayes","broom","metR","viridis"
)


Install (first time only):

install.packages(c("dplyr","tidyr","readxl","tidyverse","ggplot2","ggthemes","scales",
                   "gridExtra","automap","sf","terra","sp","raster","spdep",
                   "interactions","tidybayes","broom","metR","viridis"))
# Get brms and isdbayes from CRAN if available, else from their repos as documented.
install.packages("brms")
install.packages("isdbayes")

Parallel settings: The script uses threads = 12, cores = 32 in brm(). Adjust to your machine.

# Quick Start

Open R (or RStudio) in the project directory.

Make sure TA_GSA16_treated_new and Medits_TC_GSA16_1994_2023 are loaded in memory (or edit the script to readRDS() / read_csv() them).

Open script.R.

(Optional) Set your target species via species_code (see below).

Source the script:

source("script.R")


You should see:

model summary from brms,

a contour figure of λ across temperature & fishing, and

an interaction plot plus a tidy table of 95% CIs from a descriptive LM on the conditional-effects surface.

What the Script Does (Step-by-Step)

Build identifiers & swept area.

Computes SWEPT_AREA = ((WING_OPENING*0.1)*DISTANCE)/1e6 (km²).

Creates HAUL_ID = paste0("N", HAUL_NUMBER, "_Y", YEAR, "_Z", AREA) in both tables.

Merge & select species.

Joins TC → TA by HAUL_ID.

Filters to the chosen species_code (e.g., "MULL_BAR").

Excludes problem years and keeps post-2000 observations.

Standardize counts & weights.

Applies subsample factor subcamp = WEIGHT_OF_THE_FRACTION / WEIGHT_OF_THE_SAMPLE_MEASURED.

Standardizes counts per swept area:
num_st = (NUMBER_OF_INDIVIDUALS... * subcamp) / SWEPT_AREA.

Converts lengths to weight (g) via length–weight: ww_g = a * (L/10)^b.
(You can replace a, b with species-specific values.)

Expands counts via uncount(num_st2) for the Pareto counts interface.

Truncated Pareto setup.

Computes global xmin and site-level xmax (site = Site column if present, else HAUL_ID).

Attaches xmin/xmax to rows for vreal().

Center covariates (center-only).

fish_c = Fishing - mean(Fishing), thetao_c = thetao_mean - mean(thetao_mean), etc.

Stores means for axis back-transforms in plots.

Fit Bayesian model (size spectrum):

ww_g | vreal(num_st2, xmin, xmax) ~ fish_c * thetao_c


family = isdbayes::paretocounts() with priors on Intercept and slopes.

Note: you must define stanvars as recommended in the isdbayes documentation for paretocounts() + brms.

Visualize conditional effects.

Uses conditional_effects(fit_nor, "fish_c:thetao_c").

Back-transforms centered axes for human-readable labels.

Draws a filled contour of λ.

# Summarize the interaction (descriptive).

Fits an ordinary LM on the conditional-effects surface for quick 95% CIs and interaction lines.

Increases print precision so CI bounds don’t collapse visually due to rounding.

Customization

Species: edit

species_code <- "MULL_BAR"   # e.g., "MERL_MER", "MULL_SUR", "PAPE_LON", "NEPR_NOR", "LOLI_VUL", ...


Years to exclude: edit

years_exclude <- c(2013, 2014, 2017, 2020, 2021)


Length–weight parameters: set a, b to species-specific literature values.

Parallelism: reduce threads / cores if compilation is slow or you have fewer CPUs.

Plots: swap to your preferred palettes/themes or save figures via ggsave().

Notes on Scaling / Back-Transforms

The script uses center-only scaling (scale(..., center = TRUE, scale = FALSE)).

To interpret axes in original units, add back the mean:
original = centered + mean(original).
(No division by SD is required because we did not scale by SD.)

Outputs You Can Expect

Bayesian fit: fit_nor (brms model object).

Conditional surface data: int_plot_data (for plotting and LM summary).

LM summary: mod_final + broom::tidy(mod_final, conf.int = TRUE).

Figures:

Filled contour of λ vs. fish_unscaled × thetao_unscaled.

Interaction lines at selected moderator values (quantiles).

Troubleshooting & FAQs

object 'fish_c' not found
You’re likely fitting/plotting against the wrong data frame. Make sure you build:

int_plot <- conditional_effects(fit_nor, "fish_c:thetao_c")
int_plot_data <- as_tibble(int_plot$`fish_c:thetao_c`)


and then use that object.

object 'int_plot_data_SUL' not found
The script standardizes on int_plot_data. Replace old names with this object.

stanvars not found / undefined
isdbayes requires Stan data/functions to be passed via stanvars for paretocounts().
Follow the package documentation/vignette for the canonical definition and include it before brm().

95% CI lower/upper look identical
They’re extremely narrow; increase print precision:

options(pillar.sigfig = 12)
broom::tidy(mod_final, conf.int = TRUE)

Model takes a long time
Lower iter (e.g., 2000), reduce threads/cores, or run fewer chains while testing.

Collinearity / diagnostics
Use plot(fit_nor) for MCMC diagnostics and posterior predictive checks.
For the LM helper, inspect residuals with plot(mod_final).

Reproducibility

Set a seed if needed for init randomness:

set.seed(123)

Freeze package versions with renv:

install.packages("renv"); renv::init()

# Attribution

brms for Bayesian modeling (Stan backend).

isdbayes for truncated-Pareto (paretocounts) size-spectrum modeling and vreal() interface.

interactions for quick interaction plots with LM summaries.

metR and viridis for filled contours/colormaps.
